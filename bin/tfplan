#!/usr/bin/env bash

# source tfcommon from same bin folder
. "$(dirname $(realpath $0))/tfcommon"

echo "Current working directory: $(pwd)"
# echo "Files in current directory: $(ls -la)"
echo "Detected folder ${folder}, env ${env}"

usage() {
  echo "usage: $0 <folder>"
  echo "example: $0 aws"
  exit 1
}
[[ -z "$folder" ]] && usage

echo "tf plan $folder"

is_tf_folder $folder || usage

setupworkfolder $folder || { echo "Failed to setup work folder $folder"; exit 1; }

terraform fmt -check -v

terraform init -migrate-state -upgrade

terraform plan -input=false -out plan.tfplan
